(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{465:function(s,a,t){s.exports=t.p+"assets/img/202207301.9dbafb9e.png"},466:function(s,a,t){s.exports=t.p+"assets/img/202207302.b15a3d53.png"},467:function(s,a,t){s.exports=t.p+"assets/img/202207303.07b557b1.png"},468:function(s,a,t){s.exports=t.p+"assets/img/202207304.5f77704b.png"},508:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"vsphere嵌套虚拟化-虚拟机黑屏现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vsphere嵌套虚拟化-虚拟机黑屏现象"}},[s._v("#")]),s._v(" vSphere嵌套虚拟化-虚拟机黑屏现象")]),s._v(" "),a("h2",{attrs:{id:"描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#描述"}},[s._v("#")]),s._v(" 描述")]),s._v(" "),a("p",[s._v("在 vSphere Client 中部署一台RHEL 7.5环境，然后在RHEL 7.5环境中安装 libvirt组件，之后再RHEL 7.5中导入准备好的qcow2镜像。")]),s._v(" "),a("br"),s._v(" "),a("br"),s._v(" "),a("h2",{attrs:{id:"思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[s._v("#")]),s._v(" 思路")]),s._v(" "),a("p",[s._v("曾经我在真实设备上部署过虚拟化也遇到过一次导入的虚拟机一打开就是黑屏的情况，当时费了半天劲才查出来是BIOS中没有开启硬件辅助虚拟化功能；结合这次遇到情况，首先因为RHEL 7.5是可以正常运行的，排除硬件辅助虚拟化没有开启的情况，判断可能是虚拟机虚拟的BIOS没有开启此功能，所以可以尝试打开这一个功能。")]),s._v(" "),a("br"),s._v(" "),a("br"),s._v(" "),a("h2",{attrs:{id:"解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[s._v("#")]),s._v(" 解决")]),s._v(" "),a("ol",[a("li",[s._v("打开RHEL 7.5虚拟机的 "),a("code",[s._v("*.vmx")]),s._v(" 所在位置")])]),s._v(" "),a("img",{staticStyle:{zoom:"100%"},attrs:{src:t(465)}}),s._v(" "),a("img",{staticStyle:{zoom:"100%"},attrs:{src:t(466)}}),s._v(" "),a("img",{staticStyle:{zoom:"100%"},attrs:{src:t(467)}}),s._v(" "),a("img",{staticStyle:{zoom:"100%"},attrs:{src:t(468)}}),s._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[s._v("修改RHEL 7.5虚拟机的配置文件 "),a("code",[s._v("*.vmx")])])]),s._v(" "),a("p",[s._v("在配置文件最后一行添加如下内容:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 中间不要保留空行")]),s._v("\nvhv.enable "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TRUE"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[a("p",[s._v("重启虚拟机")])]),s._v(" "),a("li",[a("p",[s._v("检查硬件是否支持虚拟机")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果回显有vmx或者svm，说明硬件支持虚拟化；vmx是Intel，svm是AMD")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'(vmx|svm)'")]),s._v(" /proc/cpuinfo\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^flags.*(vmx|svm)'")]),s._v(" /proc/cpuinfo\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dmesg")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kvm\nlsmod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kvm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ol",{attrs:{start:"5"}},[a("li",[s._v("内核加载 kvm模块并再次检查")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("modprobe kvm\nmodprobe kvm_intel\nlsmod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kvm\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"6"}},[a("li",[s._v("删掉原先嵌套进入RHEL7.5环境的虚拟机")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里定义该嵌套虚拟机的名称为 win")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 强制关机")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("virsh")]),s._v(" destroy win\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 释放资源")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("virsh")]),s._v(" undefine win\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# 当然也可以通过vnc桌面处理也行: "virt-manager图形化中, 删除掉原先导入的虚拟机, 但保留原文件, 再次导入虚拟机即可"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("ol",{attrs:{start:"7"}},[a("li",[s._v("重新导入虚拟机")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里我使用的嵌套虚拟机win是提前配置的qcow2镜像，所以我可以通过如下命令直接导入")]),s._v("\nvirt-install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("win "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--ram")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--vcpus")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/libvirt/images/app-win2012_v1.0.qcow2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("network")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("default "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--input")]),s._v(" tablet,bus"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("usb "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--autostart")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--noreboot")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--quiet")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动虚拟机win")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("virsh")]),s._v(" start win\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("strong",[s._v("注意")]),a("br"),s._v("\n在多层嵌套虚拟机化时，请在最底层的虚拟机配置文件中加入 "),a("code",[s._v('vhv.enable = "TRUE"')]),s._v(" 参数")])])])}),[],!1,null,null,null);a.default=e.exports}}]);